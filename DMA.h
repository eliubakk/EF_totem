/****************************
 * Written by Erik Liubakka *
 ****************************/

/********************************************************************
 *                                                                  *
 * For use with the BCM2836 Broadcom chip on the Raspberry Pi 2     *
 *                                                                  *
 * Registers and functions for the following Peripherals            *
 *      - DMA                                                       *
 *                                                                  *
 ********************************************************************/

/********************************************************************
 *                          UPDATE HISTORY                          *
 ********************************************************************
 *     DATE     |                   WHAT CHANGED                    *
 ********************************************************************
 *  2019-12-10  | Initial Revision, moved from BCM2836_HW.*         *
 ********************************************************************/

#ifndef __DMA_H__
#define __DMA_H__

/*************************************************************************************
 *    INCLUDES                                                                       *
 *************************************************************************************/

#include "BCM2836_HW.h"

/*************************************************************************************
 *    DEFINES                                                                        *
 *************************************************************************************/

/* DMA DREQ Peripheral Assignments */
#define DMA_DREQ_PWM	5

/*************************************************************************************
 *    MACROS                                                                         *
 *************************************************************************************/


/*************************************************************************************
 *    TYPE/ENUM DEFINITIONS                                                          *
 *************************************************************************************/

/*
 * DMA Control Block in Main Memory
 *
 * Note: Must start at a 256 bit aligned address.
 *       Use corresponding register field definitions.
 */
typedef struct
{
    uint32_t ti;
    uint32_t source_ad;
    uint32_t dest_ad;
    uint32_t txfr_len;
    uint32_t stride;
    uint32_t nextconbk;
    uint32_t reserved[2];
} __attribute__((packed, aligned(4))) dma_cb_t;

typedef uint32_t	DMA_channel_t;

/*************************************************************************************
 *    GLOBAL VARIABLES                                                               *
 *************************************************************************************/

volatile extern dma_cb_t dma_cb;

/*************************************************************************************
 *    GLOBAL FUNCTION PROTOTYPES                                                     *
 *************************************************************************************/

uint8_t DMA_init( DMA_channel_t channel, uint32_t source_addr, uint32_t dest_addr, uint32_t tx_len );

void DMA_start( DMA_channel_t channel );

uint8_t DMA_wait( DMA_channel_t channel );

/*************************************************************************************/

#endif